name: Release Please

on:
  workflow_call:
    inputs:
      config-file:
        description: 'Path to release-please config'
        required: false
        default: 'release-please-config.json'
        type: string
      runner:
        description: 'Runner label'
        required: false
        default: 'ubuntu-latest'
        type: string
      manifest-file:
        description: 'Path to release-please manifest'
        required: false
        default: '.release-please-manifest.json'
        type: string
      component-output-key:
        description: 'Optional component path for monorepo outputs (for example clients/typescript)'
        required: false
        default: ''
        type: string
      cancel-in-progress:
        description: 'Cancel previous in-progress runs for same ref'
        required: false
        default: true
        type: boolean
    secrets:
      token:
        description: 'GitHub token'
        required: false
    outputs:
      release_created:
        description: 'Whether a release was created'
        value: ${{ jobs.release-please.outputs.release_created }}
      tag_name:
        description: 'Created release tag'
        value: ${{ jobs.release-please.outputs.tag_name }}
      component_release_created:
        description: 'Whether release was created for component-output-key'
        value: ${{ jobs.release-please.outputs.component_release_created }}
      component_tag_name:
        description: 'Created release tag for component-output-key'
        value: ${{ jobs.release-please.outputs.component_tag_name }}
      raw_outputs_json:
        description: 'All release-please step outputs as JSON'
        value: ${{ jobs.release-please.outputs.raw_outputs_json }}

jobs:
  release-please:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 15
    concurrency:
      group: ${{ format('{0}:{1}:{2}', github.workflow, github.repository, github.ref) }}
      cancel-in-progress: ${{ inputs.cancel-in-progress }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      component_release_created: ${{ inputs.component-output-key != '' && steps.release.outputs[format('{0}--release_created', inputs.component-output-key)] || '' }}
      component_tag_name: ${{ inputs.component-output-key != '' && steps.release.outputs[format('{0}--tag_name', inputs.component-output-key)] || '' }}
      raw_outputs_json: ${{ toJSON(steps.release.outputs) }}
    steps:
      - id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        with:
          config-file: ${{ inputs.config-file }}
          manifest-file: ${{ inputs.manifest-file }}
          token: ${{ secrets.token || github.token }}

      - name: Summary
        if: ${{ always() }}
        run: |
          {
            echo "### Release Please summary"
            echo "- runner: \`${{ inputs.runner }}\`"
            echo "- config-file: \`${{ inputs.config-file }}\`"
            echo "- manifest-file: \`${{ inputs.manifest-file }}\`"
            echo "- release_created: \`${{ steps.release.outputs.release_created }}\`"
            echo "- tag_name: \`${{ steps.release.outputs.tag_name }}\`"
            echo "- component-output-key: \`${{ inputs.component-output-key }}\`"
            echo "- component_release_created: \`${{ inputs.component-output-key != '' && steps.release.outputs[format('{0}--release_created', inputs.component-output-key)] || '' }}\`"
            echo "- component_tag_name: \`${{ inputs.component-output-key != '' && steps.release.outputs[format('{0}--tag_name', inputs.component-output-key)] || '' }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
